trigger: none

pool:
  vmImage: ubuntu-latest

variables:
  TERRAFORM_WORKING_DIR: IaaC

stages:
# ------------------- Terraform destroy Stage -------------------
  - stage: Terraform_destroy
    displayName: Terraform Destroy
    jobs:
      - job: terraform_destroy_job
        displayName: Terraform Destroy Job
        steps:
          - checkout: self

          # Install Terraform if not present
          - task: AzureCLI@2
            displayName: Install latest Terraform
            inputs:
              azureSubscription: ado
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "üîç Checking if Terraform is installed..."
                if ! command -v terraform &> /dev/null
                then
                  echo "üö´ Terraform not found. Installing latest Terraform..."
                  sudo apt-get update -y
                  sudo apt-get install -y jq unzip curl
                  latest_version=$(curl -s https://checkpoint-api.hashicorp.com/v1/check/terraform | jq -r .current_version)
                  echo "‚¨áÔ∏è Downloading Terraform $latest_version..."
                  curl -s -O https://releases.hashicorp.com/terraform/${latest_version}/terraform_${latest_version}_linux_amd64.zip
                  unzip -q terraform_${latest_version}_linux_amd64.zip
                  sudo mv terraform /usr/local/bin/
                  terraform -version
                else
                  echo "‚úÖ Terraform is already installed:"
                  terraform -version
                fi

          # Destroy Dev environment
          - task: AzureCLI@2
            displayName: Terraform Destroy DEV
            inputs:
              azureSubscription: ado
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                cd $(TERRAFORM_WORKING_DIR)
                terraform init -reconfigure -backend-config=dev/backend.tfvars
                terraform destroy -auto-approve -var-file=dev/dev.tfvars

          # Destroy QA environment
          - task: AzureCLI@2
            displayName: Terraform Destroy QA
            inputs:
              azureSubscription: ado
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                cd $(TERRAFORM_WORKING_DIR)
                terraform init -reconfigure -backend-config=qa/backend.tfvars
                terraform destroy -auto-approve -var-file=qa/qa.tfvars

          # Destroy PROD environment
          - task: AzureCLI@2
            displayName: Terraform Destroy PROD
            inputs:
              azureSubscription: ado
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                cd $(TERRAFORM_WORKING_DIR)
                terraform init -reconfigure -backend-config=prod/backend.tfvars
                terraform destroy -auto-approve -var-file=prod/prod.tfvars
